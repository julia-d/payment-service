name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: mvn checkstyle:check

      - name: Run SpotBugs
        run: mvn spotbugs:check

      - name: Run Spotless (format check)
        run: mvn spotless:check

  test:
    name: Test with Coverage Gate
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run tests with coverage
        run: mvn -Dspring.profiles.active=test clean test jacoco:report

      - name: Check coverage gate (80%)
        run: mvn org.jacoco:jacoco-maven-plugin:0.8.11:check@check -Djacoco.csvOutputFile=coverage.csv -Dorg.jacoco.agent.destfile=target/jacoco.exec

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Build Docker image
        run: docker build -t payment-service:${{ github.sha }} .

      - name: Run container and verify actuator health
        shell: bash
        run: |
          set -euo pipefail

          CONTAINER_NAME=payment-service-ci
          IMAGE=payment-service:${{ github.sha }}
          ACTUATOR_URL="http://localhost:8081/actuator/health"

          echo "Starting container $CONTAINER_NAME from image $IMAGE"
          docker run -d --name "$CONTAINER_NAME" -p 8081:8081 "$IMAGE"

          echo "Initial sleep 60 seconds before health polling"
          sleep 60

          echo "Starting actuator health polling for up to 60 seconds"
          START_TIME=$(date +%s)
          HEALTH_OK=0

          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            if [ "$ELAPSED" -ge 60 ]; then
              echo "Actuator health endpoint did not become healthy within 60 seconds of polling"
              break
            fi

            echo "Requesting actuator health at $ACTUATOR_URL (elapsed ${ELAPSED}s)"
            HTTP_CODE=$(curl -s -o /tmp/health_body -w "%{http_code}" "$ACTUATOR_URL" || echo "000")
            echo "HTTP status code: $HTTP_CODE"
            echo "Response body:"
            cat /tmp/health_body || true

            if [ "$HTTP_CODE" = "200" ] && grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' /tmp/health_body; then
              echo "Actuator health is UP"
              HEALTH_OK=1
              break
            fi

            echo "Actuator health not UP yet, waiting 5 seconds before next retry"
            sleep 5
          done

          echo "Stopping and removing container $CONTAINER_NAME"
          docker logs "$CONTAINER_NAME" || true
          docker rm -f "$CONTAINER_NAME" || true

          if [ "$HEALTH_OK" -ne 1 ]; then
            echo "ERROR: Actuator health check failed. See logs above for details."
            exit 1
          fi

          echo "Actuator health check succeeded. Build stage completed successfully."
