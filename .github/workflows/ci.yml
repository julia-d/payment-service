name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: mvn checkstyle:check

      - name: Run SpotBugs
        run: mvn spotbugs:check

      - name: Run Spotless (format check)
        run: mvn spotless:check

  test:
    name: Test with Coverage Gate
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run tests with coverage
        run: mvn -Dspring.profiles.active=test clean test jacoco:report

      - name: Check coverage gate (80%)
        run: mvn org.jacoco:jacoco-maven-plugin:0.8.11:check@check -Djacoco.csvOutputFile=coverage.csv -Dorg.jacoco.agent.destfile=target/jacoco.exec

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Build Docker image
        run: docker build -t payment-service:${{ github.sha }} .

      - name: Test Docker image
        run: |
          set -euo pipefail

          CONTAINER_NAME=payment-service-ci
          IMAGE=payment-service:${{ github.sha }}

          echo "Starting container $CONTAINER_NAME from image $IMAGE"
          docker run -d --name "$CONTAINER_NAME" -p 9090:9090 "$IMAGE"

          echo "Waiting 60 seconds for the container to initialize before starting health checks"
          sleep 60

          echo "Installing grpcurl to call the gRPC health method"
          curl -sL -o /tmp/grpcurl.tar.gz "https://github.com/fullstorydev/grpcurl/releases/download/v1.8.7/grpcurl_1.8.7_linux_x86_64.tar.gz"
          tar -xzf /tmp/grpcurl.tar.gz -C /tmp
          sudo mv /tmp/grpcurl /usr/local/bin/grpcurl
          sudo chmod +x /usr/local/bin/grpcurl

          echo "Gathering initial container diagnostics"
          docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          docker inspect --format '{{json .State}}' "$CONTAINER_NAME" || true
          echo "Recent container logs (last 200 lines):"
          docker logs --tail 200 "$CONTAINER_NAME" || true

          echo "Waiting for gRPC PaymentService health RPC payments.v1.Payment/health to return a status of \"OK\""
          SUCCESS=0

          for i in $(seq 1 30); do
            echo "Attempt $i: invoking gRPC health method..."
            OUT=$(/usr/local/bin/grpcurl -plaintext -proto src/main/proto/payment.proto -d '{}' localhost:9090 payments.v1.Payment/health 2>&1) || true
            EXIT_CODE=$?
            echo "grpcurl exit_code=$EXIT_CODE"
            echo "grpcurl output:\n$OUT"

            # Check for status OK in the output (accepts either JSON or proto-style output)
            if echo "$OUT" | grep -q '"status"[[:space:]]*:[[:space:]]*"OK"' || echo "$OUT" | grep -q 'status:[[:space:]]*"OK"'; then
              echo "gRPC health check passed on attempt $i"
              SUCCESS=1
              break
            fi

            echo "gRPC health check not ready yet (attempt $i). Dumping recent container logs to help debugging..."
            docker logs --tail 100 "$CONTAINER_NAME" || true
            sleep 2
          done

          if [ "$SUCCESS" -ne 1 ]; then
            echo "gRPC health check failed after retries - full diagnostics follow"
            echo "== Container logs (full) =="
            docker logs "$CONTAINER_NAME" || true
            echo "== Container inspect =="
            docker inspect "$CONTAINER_NAME" || true
            echo "== Docker ps -a =="
            docker ps -a || true
            echo "== Net listening on host (show TCP listeners) =="
            ss -ltnp || netstat -ltnp || true
            docker rm -f "$CONTAINER_NAME" || true
            exit 1
          fi

          echo "Service started successfully (gRPC health OK), stopping container"
          docker rm -f "$CONTAINER_NAME"
