name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

permissions:
  contents: read
  security-events: write
  actions: read

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run Checkstyle
        run: mvn checkstyle:check

      - name: Run SpotBugs
        if: success()
        run: mvn spotbugs:check

      - name: Run Spotless (format check)
        if: success()
        run: mvn spotless:check


  test:
    name: Test with Coverage Gate
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Create env.properties
        run: |
          DB_URL="${{ secrets.DB_URL }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          cat > src/main/resources/env.properties << 'ENVEOF'
          db.url=PLACEHOLDER_DB_URL
          db.username=PLACEHOLDER_DB_USERNAME
          db.password=PLACEHOLDER_DB_PASSWORD
          ENVEOF
          sed -i "s|PLACEHOLDER_DB_URL|${DB_URL}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_USERNAME|${DB_USERNAME}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_PASSWORD|${DB_PASSWORD}|g" src/main/resources/env.properties
          echo "env.properties created successfully"

      - name: Run tests with coverage
        run: mvn -Dspring.profiles.active=test clean test jacoco:report

      - name: Check coverage gate (10%)
        run: mvn org.jacoco:jacoco-maven-plugin:0.8.11:check@check -Djacoco.csvOutputFile=coverage.csv -Dorg.jacoco.agent.destfile=target/jacoco.exec

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Create env.properties
        run: |
          DB_URL="${{ secrets.DB_URL }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          cat > src/main/resources/env.properties << 'ENVEOF'
          db.url=PLACEHOLDER_DB_URL
          db.username=PLACEHOLDER_DB_USERNAME
          db.password=PLACEHOLDER_DB_PASSWORD
          ENVEOF
          sed -i "s|PLACEHOLDER_DB_URL|${DB_URL}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_USERNAME|${DB_USERNAME}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_PASSWORD|${DB_PASSWORD}|g" src/main/resources/env.properties
          echo "env.properties created successfully"

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Verify env.properties in JAR
        run: |
          JAR_FILE=$(ls target/payment-service-*.jar | head -1)
          if [ -n "$JAR_FILE" ]; then
            if unzip -l "$JAR_FILE" | grep -q "env.properties"; then
              echo "✓ env.properties is packaged in JAR"
            else
              echo "ERROR: env.properties NOT found in JAR!"
              exit 1
            fi
          else
            echo "ERROR: No JAR file found!"
            exit 1
          fi

      - name: Build Docker image
        run: docker build -t payment-service:${{ github.sha }} .

      - name: Run container and verify health
        shell: bash
        run: |
          set -euo pipefail

          CONTAINER_NAME=payment-service-ci
          IMAGE=payment-service:${{ github.sha }}

          echo "Starting container $CONTAINER_NAME from image $IMAGE"
          docker run -d \
            --name "$CONTAINER_NAME" \
            -p 8081:8081 \
            -p 9090:9090 \
            "$IMAGE"

          echo "Waiting for Docker health check (up to 60 seconds)..."
          SECONDS=0
          MAX_WAIT=60

          while [ $SECONDS -lt $MAX_WAIT ]; do
            HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "none")
            echo "Health status at ${SECONDS}s: $HEALTH_STATUS"

            if [ "$HEALTH_STATUS" = "healthy" ]; then
              echo "✓ Container is healthy"
              docker logs "$CONTAINER_NAME" 2>&1 | tail -20
              docker rm -f "$CONTAINER_NAME"
              echo "Container stopped and removed successfully"
              exit 0
            fi

            if [ "$HEALTH_STATUS" = "unhealthy" ] || ! docker ps -q -f name="^${CONTAINER_NAME}$" | grep -q .; then
              echo "ERROR: Container is unhealthy or stopped"
              docker logs "$CONTAINER_NAME" 2>&1 || true
              docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
              exit 1
            fi

            sleep 3
            SECONDS=$((SECONDS + 3))
          done

          echo "ERROR: Container did not become healthy within ${MAX_WAIT} seconds"
          docker logs "$CONTAINER_NAME" 2>&1 || true
          docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
          exit 1
