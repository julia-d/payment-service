name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

permissions:
  contents: read
  security-events: write
  actions: read

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run Checkstyle
        run: mvn checkstyle:check

      - name: Run SpotBugs
        if: success()
        run: mvn spotbugs:check

      - name: Run Spotless (format check)
        if: success()
        run: mvn spotless:check


  test:
    name: Test with Coverage Gate
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Create env.properties
        run: |
          DB_URL="${{ secrets.DB_URL }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          cat > src/main/resources/env.properties << 'ENVEOF'
          db.url=PLACEHOLDER_DB_URL
          db.username=PLACEHOLDER_DB_USERNAME
          db.password=PLACEHOLDER_DB_PASSWORD
          ENVEOF
          sed -i "s|PLACEHOLDER_DB_URL|${DB_URL}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_USERNAME|${DB_USERNAME}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_PASSWORD|${DB_PASSWORD}|g" src/main/resources/env.properties
          echo "env.properties created successfully"

      - name: Run tests with coverage
        run: mvn -Dspring.profiles.active=test clean test jacoco:report

      - name: Check coverage gate (10%)
        run: mvn org.jacoco:jacoco-maven-plugin:0.8.11:check@check -Djacoco.csvOutputFile=coverage.csv -Dorg.jacoco.agent.destfile=target/jacoco.exec

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Create env.properties
        run: |
          DB_URL="${{ secrets.DB_URL }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          cat > src/main/resources/env.properties << 'ENVEOF'
          db.url=PLACEHOLDER_DB_URL
          db.username=PLACEHOLDER_DB_USERNAME
          db.password=PLACEHOLDER_DB_PASSWORD
          ENVEOF
          sed -i "s|PLACEHOLDER_DB_URL|${DB_URL}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_USERNAME|${DB_USERNAME}|g" src/main/resources/env.properties
          sed -i "s|PLACEHOLDER_DB_PASSWORD|${DB_PASSWORD}|g" src/main/resources/env.properties
          echo "env.properties created successfully"

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Verify env.properties in JAR
        run: |
          JAR_FILE=$(ls target/payment-service-*.jar | head -1)
          if [ -n "$JAR_FILE" ]; then
            if unzip -l "$JAR_FILE" | grep -q "env.properties"; then
              echo "âœ“ env.properties is packaged in JAR"
            else
              echo "ERROR: env.properties NOT found in JAR!"
              exit 1
            fi
          else
            echo "ERROR: No JAR file found!"
            exit 1
          fi

      - name: Build Docker image
        run: docker build -t payment-service:${{ github.sha }} .

      - name: Run container and verify actuator health
        shell: bash
        run: |
          set -euo pipefail

          CONTAINER_NAME=payment-service-ci
          IMAGE=payment-service:${{ github.sha }}
          ACTUATOR_URL="http://localhost:8081/actuator/health"

          echo "Starting container $CONTAINER_NAME from image $IMAGE"
          docker run -d \
            --name "$CONTAINER_NAME" \
            -p 8081:8081 \
            -p 9090:9090 \
            "$IMAGE"

          echo "Waiting 10 seconds for initial startup..."
          sleep 10
          
          echo "=== Container logs (first 10 seconds) ==="
          docker logs "$CONTAINER_NAME" 2>&1 | tail -50
          echo "=== End of initial logs ==="

          echo "Waiting additional 50 seconds before health polling"
          sleep 50

          echo "Starting actuator health polling for up to 60 seconds"
          START_TIME=$(date +%s)
          HEALTH_OK=0

          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            if [ "$ELAPSED" -ge 60 ]; then
              echo "Actuator health endpoint did not become healthy within 60 seconds of polling"
              break
            fi

            echo "Requesting actuator health at $ACTUATOR_URL (elapsed ${ELAPSED}s)"
            HTTP_CODE=$(curl -s -o /tmp/health_body -w "%{http_code}" "$ACTUATOR_URL" || echo "000")
            echo "HTTP status code: $HTTP_CODE"
            echo "Response body:"
            cat /tmp/health_body || true

            if [ "$HTTP_CODE" = "200" ] && grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' /tmp/health_body; then
              echo "Actuator health is UP"
              HEALTH_OK=1
              break
            fi

            echo "Actuator health not UP yet, waiting 5 seconds before next retry"
            sleep 5
          done

          echo "Stopping and removing container $CONTAINER_NAME"
          docker logs "$CONTAINER_NAME" || true
          docker rm -f "$CONTAINER_NAME" || true

          if [ "$HEALTH_OK" -ne 1 ]; then
            echo "ERROR: Actuator health check failed. See logs above for details."
            exit 1
          fi

          echo "Actuator health check succeeded. Build stage completed successfully."
